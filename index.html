<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steamboat Planner - ãƒ¬ãƒˆãƒ­ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å¸³</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- æ²¹æ€§ãƒã‚¸ãƒƒã‚¯ (Yusei Magic) ãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ -->
    <link href="https://fonts.googleapis.com/css2?family=Yusei+Magic&display=swap" rel="stylesheet">
    <style>
        /* ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã¨ã‚«ã‚¹ã‚¿ãƒ CSS */
        :root {
            --color-white: #FEFEFE;
            --color-black: #111827;
            --color-yellow: #FFC72C; /* ã‚¹ãƒ­ãƒƒãƒˆã€è­¦å‘Š */
            --color-red: #D32F2F;   /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã€ç‚¹æ»…ã‚³ãƒ­ãƒ³ */
        }
        body {
            /* æ‰‹æ›¸ãæ„Ÿã®ã‚ã‚‹ãƒ•ã‚©ãƒ³ãƒˆã«å¤‰æ›´ */
            font-family: 'Yusei Magic', cursive, sans-serif;
            background-color: var(--color-white);
            color: var(--color-black);
            margin: 0;
            padding-bottom: 72px; /* ãƒ•ãƒƒã‚¿ãƒ¼ã®é«˜ã• */
            /* ãƒ•ã‚£ãƒ«ãƒ ç²’å­ãƒ†ã‚¯ã‚¹ãƒãƒ£ã®è¿½åŠ  */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23n)' opacity='0.08'/%3E%3C/svg%3E");
        }

        /* å¤ªã„ã‚¤ãƒ³ã‚¯ç·šã‚¹ã‚¿ã‚¤ãƒ« */
        .ink-border {
            border: 4px solid var(--color-black);
            border-radius: 8px; /* ä¸¸ã¿ã‚’å°‘ã—åŠ ãˆã¦ãƒ¬ãƒˆãƒ­æ„Ÿã‚’å‡ºã™ */
        }

        /* ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ•ã‚©ãƒ³ãƒˆé¢¨ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ */
        .retro-digital {
            font-family: 'DSEG7 Classic', 'Courier New', monospace;
            /* ã‚µã‚¤ã‚ºã‚’å¤§ããå¤‰æ›´ */
            font-size: 2.5rem; 
            letter-spacing: 2px;
            font-weight: 700;
        }

        /* ç‚¹æ»…ã‚³ãƒ­ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes blink {
            0%, 49% { color: var(--color-red); }
            50%, 100% { color: var(--color-black); }
        }
        .blinking-colon {
            animation: blink 1s step-end infinite;
            display: inline-block;
            width: 8px; /* ã‚³ãƒ­ãƒ³ã®å¹…ã‚’èª¿æ•´ */
        }

        /* ãƒ¢ãƒã‚¤ãƒ«ãƒ“ãƒ¥ãƒ¼ã®æœ€é©åŒ– */
        #app-container {
            max-width: 600px;
            min-height: 100vh;
            margin: 0 auto;
            background-color: var(--color-white);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        /* ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ */
        .view-content {
            padding: 16px;
            min-height: calc(100vh - 128px); /* ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒ•ãƒƒã‚¿ãƒ¼ã‚’è€ƒæ…® */
        }

        /* ã‚¹ãƒ­ãƒƒãƒˆåˆ†æã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
        .slot-highlight {
            background-color: rgba(255, 199, 44, 0.4); /* é»„è‰²ã®åŠé€æ˜ */
            position: absolute;
            z-index: 10;
        }

        /* ã‚³ãƒæ’®ã‚Šé¢¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: çŠ¶æ…‹åˆ‡ã‚Šæ›¿ãˆã§è¦–è¦šçš„ãªã‚¸ãƒ£ãƒ³ãƒ—ã‚’ç™ºç”Ÿã•ã›ã‚‹ */
        .steamboat-button {
            transition: all 0.05s steps(2); /* 0.05ç§’ã®çŸ­ã„ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ã€2ã‚¹ãƒ†ãƒƒãƒ—ã§ã‚«ã‚¯ã‚«ã‚¯å‹•ã‹ã™ */
        }
        .steamboat-button:active {
            transform: scale(0.95);
        }

        /* å¤©æ°—ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .weather-icon {
            font-size: 24px;
            line-height: 1;
        }
    </style>
</head>
<body class="bg-gray-900">
    <div id="app-container" class="ink-border shadow-2xl">

        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ (ç¾åœ¨æ™‚åˆ»è¡¨ç¤ºã®ã¿) -->
        <header class="p-3 bg-white ink-border-b sticky top-0 z-20 flex justify-end items-center">
            <!-- ã‚¿ã‚¤ãƒˆãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ -->
            <!-- text-3xl ã«å¤‰æ›´ã—ã€ç§’æ•°è¡¨ç¤ºã«å¯¾å¿œ -->
            <div id="current-time" class="retro-digital text-3xl text-right">00<span class="blinking-colon">:</span>00<span class="blinking-colon">:</span>00</div>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ -->
        <main id="view-container" class="view-content relative"></main>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ (ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³) -->
        <footer class="fixed bottom-0 left-0 right-0 h-16 bg-white ink-border-t z-50 flex justify-around shadow-2xl mx-auto" style="max-width: 600px;">
            <button onclick="setView('month')" id="nav-month" class="flex-1 flex flex-col items-center justify-center p-2 steamboat-button text-gray-400 border-r border-gray-200">
                <span class="text-2xl">ğŸ“…</span><span class="text-xs font-bold mt-1">æœˆ</span>
            </button>
            <button onclick="setView('week')" id="nav-week" class="flex-1 flex flex-col items-center justify-center p-2 steamboat-button text-gray-400 border-r border-gray-200">
                <span class="text-2xl">ğŸ—“ï¸</span><span class="text-xs font-bold mt-1">é€±</span>
            </button>
            <button onclick="setView('task')" id="nav-task" class="flex-1 flex flex-col items-center justify-center p-2 steamboat-button text-gray-400 border-r border-gray-200">
                <span class="text-2xl">ğŸ“</span><span class="text-xs font-bold mt-1">ã‚¿ã‚¹ã‚¯</span>
            </button>
            <button onclick="setView('log')" id="nav-log" class="flex-1 flex flex-col items-center justify-center p-2 steamboat-button text-gray-400">
                <span class="text-2xl">ğŸ•°ï¸</span><span class="text-xs font-bold mt-1">æ—¥èªŒ</span>
            </button>
        </footer>

        <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ (ã‚¤ãƒ™ãƒ³ãƒˆCRUD / è©³ç´°è¡¨ç¤º) -->
        <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
            <div id="modal-content" class="bg-white ink-border w-full max-w-sm p-4 overflow-y-auto max-h-[90vh]">
                <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«å†…å®¹ã¯JSã§æŒ¿å…¥ã•ã‚Œã¾ã™ -->
            </div>
        </div>
    </div>

    <script>
        // =======================================================
        // 0. åˆæœŸè¨­å®šã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        // =======================================================

        const storageKey = 'steamboatPlannerData';
        const defaultLocation = 'æ–°æµ¦å®‰é§…'; // ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿èµ·ç‚¹ã®å ´æ‰€

        let appData = {
            schedules: [],
            currentView: 'month',
            lastId: 0,
            currentDate: new Date()
        };

        // UIè¦ç´ ã®å–å¾—
        const viewContainer = document.getElementById('view-container');
        const modalOverlay = document.getElementById('modal-overlay');
        const modalContent = document.getElementById('modal-content');

        /**
         * ãƒ‡ãƒ¼ã‚¿ã‚’localStorageã‹ã‚‰ãƒ­ãƒ¼ãƒ‰
         */
        function loadData() {
            try {
                const storedData = localStorage.getItem(storageKey);
                if (storedData) {
                    const parsedData = JSON.parse(storedData);
                    // ãƒ‡ãƒ¼ã‚¿ã®ç ´æã‚„ä¸è¶³ã‚’é˜²ããŸã‚ã®ãƒã‚§ãƒƒã‚¯
                    if (parsedData.schedules && Array.isArray(parsedData.schedules)) {
                        appData = { ...appData, ...parsedData };
                    }
                }
            } catch (e) {
                console.error("Failed to load data from localStorage", e);
                // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰å¤±æ•—æ™‚ã¯åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
            }
        }

        /**
         * ãƒ‡ãƒ¼ã‚¿ã‚’localStorageã«ä¿å­˜
         */
        function saveData() {
            try {
                localStorage.setItem(storageKey, JSON.stringify(appData));
            } catch (e) {
                console.error("Failed to save data to localStorage", e);
            }
        }

        /**
         * ç¾åœ¨æ™‚åˆ»ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¡¨ç¤ºï¼ˆèµ¤ã„ç‚¹æ»…ã‚³ãƒ­ãƒ³ä»˜ãï¼‰
         */
        function updateCurrentTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0'); // ç§’æ•°ã‚’å–å¾—

            // æ™‚åˆ†ç§’ã™ã¹ã¦ã‚’è¡¨ç¤ºã—ã€é–“ã«ç‚¹æ»…ã‚³ãƒ­ãƒ³ã‚’æŒ¿å…¥
            const timeString = `${hours}<span class="blinking-colon">:</span>${minutes}<span class="blinking-colon">:</span>${seconds}`;
            document.getElementById('current-time').innerHTML = timeString;
        }

        /**
         * æŒ‡å®šã•ã‚ŒãŸæ—¥ä»˜ã®YYYY-MM-DDå½¢å¼ã®æ–‡å­—åˆ—ã‚’è¿”ã™
         * @param {Date} date
         * @returns {string}
         */
        function formatDate(date) {
            return date.getFullYear() + '-' +
                   String(date.getMonth() + 1).padStart(2, '0') + '-' +
                   String(date.getDate()).padStart(2, '0');
        }

        /**
         * æŒ‡å®šã•ã‚ŒãŸæ—¥æ™‚ã®YYYY-MM-DDTHH:MMå½¢å¼ã®æ–‡å­—åˆ—ã‚’è¿”ã™
         * @param {Date} date
         * @returns {string}
         */
        function formatDateTimeLocal(date) {
            return date.getFullYear() + '-' +
                   String(date.getMonth() + 1).padStart(2, '0') + '-' +
                   String(date.getDate()).padStart(2, '0') + 'T' +
                   String(date.getHours()).padStart(2, '0') + ':' +
                   String(date.getMinutes()).padStart(2, '0');
        }

        // =======================================================
        // 1. ãƒ‡ãƒ¼ã‚¿æ“ä½œ (CRUD)
        // =======================================================

        /**
         * ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«/ã‚¿ã‚¹ã‚¯ã‚’ç™»éŒ²ã¾ãŸã¯æ›´æ–°
         * @param {Object} eventData - ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿
         */
        function saveEvent(eventData) {
            if (eventData.id) {
                // æ›´æ–°
                const index = appData.schedules.findIndex(e => e.id === eventData.id);
                if (index !== -1) {
                    appData.schedules[index] = eventData;
                }
            } else {
                // æ–°è¦ç™»éŒ²
                appData.lastId++;
                eventData.id = appData.lastId;
                appData.schedules.push(eventData);
            }
            saveData();
            closeModal();
            renderView(appData.currentView);
        }

        /**
         * ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«/ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤
         * @param {number} id - ã‚¤ãƒ™ãƒ³ãƒˆID
         */
        function deleteEvent(id) {
            // ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã®ä»£ã‚ã‚Šã«ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨
            showCustomMessageBox('ç¢ºèª', 'ã“ã®äºˆå®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', () => {
                appData.schedules = appData.schedules.filter(e => e.id !== id);
                saveData();
                closeModal();
                renderView(appData.currentView);
            });
        }

        /**
         * ã‚¿ã‚¹ã‚¯ã®å®Œäº†çŠ¶æ…‹ã‚’ãƒˆã‚°ãƒ«
         * @param {number} id - ã‚¿ã‚¹ã‚¯ID
         */
        function toggleTask(id) {
            const task = appData.schedules.find(e => e.id === id);
            if (task) {
                task.completed = !task.completed;
                if (task.completed) {
                    task.actualEnd = new Date().toISOString(); // å®Œäº†æ™‚åˆ»ã‚’è¨˜éŒ²
                } else {
                    task.actualEnd = null;
                }
                saveEvent(task);
            }
        }

        // =======================================================
        // 2. ãƒ¢ãƒ¼ãƒ€ãƒ«/UIå‡¦ç†
        // =======================================================

        /**
         * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
         * @param {string} contentHtml - ãƒ¢ãƒ¼ãƒ€ãƒ«ã«è¡¨ç¤ºã™ã‚‹HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„
         */
        function openModal(contentHtml) {
            modalContent.innerHTML = contentHtml;
            modalOverlay.classList.remove('hidden');
        }

        /**
         * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
         */
        function closeModal() {
            modalOverlay.classList.add('hidden');
            modalContent.innerHTML = '';
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) {
                closeModal();
            }
        });

        /**
         * ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²/ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®è¡¨ç¤º
         * @param {number|null} id - ç·¨é›†ã®å ´åˆã¯ID, æ–°è¦ã®å ´åˆã¯null
         * @param {Date} [initialDate] - æ–°è¦ä½œæˆæ™‚ã®åˆæœŸæ—¥ä»˜
         */
        function showEventForm(id = null, initialDate = appData.currentDate) {
            const event = id ? appData.schedules.find(e => e.id === id) : null;
            const isTask = event ? event.type === 'task' : false;

            const now = new Date();
            const defaultStart = new Date(initialDate.getFullYear(), initialDate.getMonth(), initialDate.getDate(), now.getHours() + 1, 0);
            const defaultEnd = new Date(defaultStart.getTime() + 60 * 60 * 1000);

            const startTime = event ? new Date(event.start) : defaultStart;
            const endTime = event ? new Date(event.end) : defaultEnd;

            const formHtml = `
                <h2 class="text-xl font-extrabold ink-border-b pb-2 mb-4">${id ? 'äºˆå®šã‚’ç·¨é›†' : 'æ–°ã—ã„äºˆå®š/ã‚¿ã‚¹ã‚¯'}</h2>
                <form id="event-form">
                    <input type="hidden" name="id" value="${id || ''}">

                    <div class="mb-4">
                        <label class="block mb-1 font-bold">ç¨®é¡</label>
                        <div class="flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="type" value="schedule" ${!isTask ? 'checked' : ''} class="mr-2 border-2 border-black" required> äºˆå®š
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="type" value="task" ${isTask ? 'checked' : ''} class="mr-2 border-2 border-black"> ã‚¿ã‚¹ã‚¯
                            </label>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="title" class="block mb-1 font-bold">ã‚¿ã‚¤ãƒˆãƒ«</label>
                        <input type="text" id="title" name="title" value="${event ? event.title : ''}"
                               class="ink-border p-2 w-full" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›" required>
                    </div>

                    <div id="datetime-fields">
                        <div class="mb-4">
                            <label for="start" class="block mb-1 font-bold">é–‹å§‹æ—¥æ™‚</label>
                            <input type="datetime-local" id="start" name="start" value="${formatDateTimeLocal(startTime)}"
                                   class="ink-border p-2 w-full" required>
                        </div>
                        <div class="mb-4">
                            <label for="end" class="block mb-1 font-bold">çµ‚äº†æ—¥æ™‚</label>
                            <input type="datetime-local" id="end" name="end" value="${formatDateTimeLocal(endTime)}"
                                   class="ink-border p-2 w-full" required>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="location" class="block mb-1 font-bold">å ´æ‰€</label>
                        <input type="text" id="location" name="location" value="${event ? event.location || '' : ''}"
                               class="ink-border p-2 w-full" placeholder="å ´æ‰€ï¼ˆä»»æ„ï¼‰">
                    </div>

                    <div class="mb-4">
                        <label for="notes" class="block mb-1 font-bold">å‚™è€ƒ</label>
                        <textarea id="notes" name="notes" class="ink-border p-2 w-full" rows="3" placeholder="è©³ç´°ã€ãƒ¡ãƒ¢">${event ? event.notes || '' : ''}</textarea>
                    </div>

                    <div class="flex justify-between items-center pt-2 border-t border-gray-300">
                        <button type="button" onclick="closeModal()" class="steamboat-button bg-gray-200 text-black px-4 py-2 ink-border">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button type="submit" class="steamboat-button bg-[var(--color-red)] text-white px-4 py-2 ink-border shadow-md">ä¿å­˜</button>
                    </div>
                </form>
            `;

            openModal(formHtml);

            document.getElementById('event-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const data = {
                    id: formData.get('id') ? parseInt(formData.get('id')) : null,
                    title: formData.get('title'),
                    type: formData.get('type'),
                    start: new Date(formData.get('start')).toISOString(),
                    end: new Date(formData.get('end')).toISOString(),
                    location: formData.get('location'),
                    notes: formData.get('notes'),
                    completed: event ? event.completed : false,
                    actualEnd: event ? event.actualEnd : null,
                };
                saveEvent(data);
            });
        }

        /**
         * ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤º
         * @param {number} id - ã‚¤ãƒ™ãƒ³ãƒˆID
         */
        function showEventDetails(id) {
            const event = appData.schedules.find(e => e.id === id);
            if (!event) return;

            const isTask = event.type === 'task';
            const start = new Date(event.start);
            const end = new Date(event.end);
            const dateStr = `${start.getMonth() + 1}æœˆ${start.getDate()}æ—¥`;
            const timeStr = `${String(start.getHours()).padStart(2, '0')}:${String(start.getMinutes()).padStart(2, '0')} - ${String(end.getHours()).padStart(2, '0')}:${String(end.getMinutes()).padStart(2, '0')}`;

            // ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
            const { time, route } = getMockRouteInfo(event.location);
            const weather = getMockWeather(start, event.location);

            const weatherWarning = weather.warning ? 'bg-[var(--color-yellow)] text-black font-bold p-1 rounded-sm' : 'text-black';

            const detailHtml = `
                <h2 class="text-2xl font-extrabold ink-border-b pb-2 mb-4">${event.title}</h2>
                <p class="text-sm text-gray-600 mb-4">${isTask ? 'ã‚¿ã‚¹ã‚¯' : 'äºˆå®š'}</p>

                <div class="space-y-3 mb-4">
                    <p class="flex justify-between items-center"><span class="font-bold">ğŸ“… æ—¥ä»˜:</span> <span>${dateStr}</span></p>
                    <p class="flex justify-between items-center"><span class="font-bold">â±ï¸ æ™‚é–“:</span> <span>${timeStr}</span></p>
                    <p class="flex justify-between items-center"><span class="font-bold">ğŸ“ å ´æ‰€:</span> <span>${event.location || 'æœªå®š'}</span></p>
                    ${event.notes ? `<p class="font-bold border-t pt-3">ğŸ“ å‚™è€ƒ:</p><p class="whitespace-pre-wrap">${event.notes}</p>` : ''}
                </div>

                <!-- å¤–éƒ¨æƒ…å ±é€£æº (ãƒ¢ãƒƒã‚¯) -->
                <div class="ink-border p-3 mt-4 bg-gray-100">
                    <h3 class="font-extrabold text-lg ink-border-b border-dashed pb-2 mb-3">ãƒ¬ãƒˆãƒ­æƒ…å ±é€£æº</h3>

                    <!-- å¤©æ°—äºˆå ±ãƒ¢ãƒƒã‚¯ -->
                    <div class="flex items-center justify-between mb-3">
                        <span class="font-bold">å¤©æ°—äºˆå ±:</span>
                        <div class="flex items-center space-x-2 ${weatherWarning}">
                            <span class="weather-icon text-2xl">${weather.icon}</span>
                            <span>${weather.condition} | ${weather.temp}Â°C (${weather.rain}% é™æ°´)</span>
                        </div>
                    </div>

                    <!-- çµŒè·¯ãƒ»æ™‚é–“æ¤œç´¢ãƒ¢ãƒƒã‚¯ -->
                    <div>
                        <p class="font-bold mb-1">ğŸš— æ–°æµ¦å®‰é§…ã‹ã‚‰ã®æ‰€è¦æ™‚é–“ (ãƒ¢ãƒƒã‚¯):</p>
                        <p class="text-sm bg-white p-2 ink-border">
                            ${time}
                            <span class="block text-xs text-gray-600 mt-1">${route}</span>
                        </p>
                    </div>
                </div>

                <div class="flex justify-between mt-6">
                    <button onclick="showEventForm(${event.id})" class="steamboat-button bg-[var(--color-yellow)] text-black px-4 py-2 ink-border font-bold">ç·¨é›†</button>
                    ${isTask ? `<button onclick="toggleTask(${event.id})" class="steamboat-button bg-green-500 text-white px-4 py-2 ink-border font-bold">${event.completed ? 'æœªå®Œäº†ã«æˆ»ã™' : 'å®Œäº†ã¨ã—ã¦è¨˜éŒ²'}</button>` : ''}
                    <button onclick="deleteEvent(${event.id})" class="steamboat-button bg-gray-800 text-white px-4 py-2 ink-border font-bold">å‰Šé™¤</button>
                </div>
            `;
            openModal(detailHtml);
        }

        /**
         * ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤º (alert/confirmã®ä»£ã‚ã‚Š)
         * @param {string} title
         * @param {string} message
         * @param {Function} onConfirm - ç¢ºèªæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
         * @param {Function} [onCancel] - ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
         */
        function showCustomMessageBox(title, message, onConfirm, onCancel = closeModal) {
            const messageBoxHtml = `
                <h2 class="text-xl font-extrabold ink-border-b pb-2 mb-4">${title}</h2>
                <p class="mb-6">${message}</p>
                <div class="flex justify-end space-x-4">
                    <button onclick="closeModal(); ${onCancel ? onCancel.name + '()' : ''}" class="steamboat-button bg-gray-200 text-black px-4 py-2 ink-border">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button onclick="${onConfirm.name}(); closeModal();" class="steamboat-button bg-[var(--color-red)] text-white px-4 py-2 ink-border shadow-md">OK</button>
                </div>
            `;
            openModal(messageBoxHtml);
        }


        // =======================================================
        // 3. å¤–éƒ¨æƒ…å ±é€£æºãƒ¢ãƒƒã‚¯
        // =======================================================

        /**
         * ãƒ¢ãƒƒã‚¯ã®çµŒè·¯ãƒ»æ™‚é–“æ¤œç´¢ (æ–°æµ¦å®‰é§…èµ·ç‚¹)
         * @param {string} destination - ç›®çš„åœ°
         * @returns {{time: string, route: string}}
         */
        function getMockRouteInfo(destination) {
            if (!destination) {
                return { time: 'å ´æ‰€ãŒæœªå…¥åŠ›ã§ã™', route: 'çµŒè·¯æƒ…å ±ãªã—' };
            }
            const hash = destination.length % 5;
            let time, route;
            switch (hash) {
                case 0:
                    time = 'é›»è»Šã§ç´„45åˆ† (ä¹—æ›1å›)';
                    route = `${defaultLocation} â†’ (JRäº¬è‘‰ç·š) â†’ ã€‡ã€‡é§…`;
                    break;
                case 1:
                    time = 'ãƒã‚¹ã§ç´„20åˆ† (ç›´è¡Œ)';
                    route = `${defaultLocation} ãƒã‚¹åœ â†’ ç›®çš„åœ°å‘¨è¾º`;
                    break;
                case 2:
                    time = 'å¾’æ­©ã§ç´„5åˆ†';
                    route = `ç›®çš„åœ°ã¯${defaultLocation}ã®è¿‘éš£ã§ã™`;
                    break;
                case 3:
                    time = 'é›»è»Šã¨ãƒã‚¹ã§ç´„1æ™‚é–“15åˆ† (ä¹—æ›2å›)';
                    route = `${defaultLocation} â†’ (JRç·š) â†’ ã€‡ã€‡é§… â†’ (ãƒã‚¹) â†’ ç›®çš„åœ°`;
                    break;
                default:
                    time = 'é›»è»Šã§ç´„30åˆ† (ä¹—æ›ãªã—)';
                    route = `${defaultLocation} â†’ (JRç·š) â†’ ç›®çš„åœ°é§…`;
                    break;
            }
            return { time, route };
        }

        /**
         * ãƒ¢ãƒƒã‚¯ã®å¤©æ°—äºˆå ±
         * @param {Date} date - äºˆå®šã®æ—¥æ™‚
         * @param {string} location - äºˆå®šã®å ´æ‰€ (ãƒ¢ãƒƒã‚¯ã§ã¯ä½¿ç”¨ã—ãªã„)
         * @returns {{icon: string, condition: string, temp: number, rain: number, warning: boolean}}
         */
        function getMockWeather(date, location) {
            const dayOfMonth = date.getDate();
            const hour = date.getHours();

            let condition, icon, rain, temp, warning = false;

            if (dayOfMonth % 7 === 0) {
                // 7ã®å€æ•°ã®æ—¥ã¯é›¨
                condition = 'å¤§é›¨';
                icon = 'ğŸŒ§ï¸';
                rain = 80;
                temp = 18;
                warning = true; // æ‚ªå¤©å€™æ™‚ã¯é»„è‰²è­¦å‘Š
            } else if (dayOfMonth % 3 === 0) {
                // 3ã®å€æ•°ã®æ—¥ã¯æ›‡ã‚Š
                condition = 'æ›‡ã‚Š';
                icon = 'â˜ï¸';
                rain = 10;
                temp = 25;
            } else {
                // ãã‚Œä»¥å¤–ã¯æ™´ã‚Œ
                condition = 'æ™´ã‚Œ';
                icon = 'â˜€ï¸';
                rain = 0;
                temp = (hour < 10 || hour > 18) ? 20 : 28;
            }

            return { icon, condition, temp, rain, warning };
        }

        // =======================================================
        // 4. é«˜åº¦ãªæ™‚é–“ç®¡ç†æ©Ÿèƒ½ (ã‚¹ãƒ­ãƒƒãƒˆåˆ†æ)
        // =======================================================

        /**
         * æŒ‡å®šã•ã‚ŒãŸæ—¥ã®ç©ºãæ™‚é–“å¸¯ (ã‚¹ãƒ­ãƒƒãƒˆ) ã‚’åˆ†æ
         * @param {Date} targetDate - å¯¾è±¡ã®æ—¥ä»˜
         * @returns {Array<{start: Date, end: Date}>} - ç©ºãæ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆã®é…åˆ—
         */
        function analyzeTimeSlots(targetDate) {
            const slots = [];
            const dayStartHour = 9; // åˆ†æé–‹å§‹æ™‚åˆ»
            const dayEndHour = 22; // åˆ†æçµ‚äº†æ™‚åˆ»

            const dayStart = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate(), dayStartHour, 0);
            const dayEnd = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate(), dayEndHour, 0);

            // å¯¾è±¡æ—¥ã®ç¢ºå®šã—ãŸäºˆå®šï¼ˆæœªå®Œäº†ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã€é–‹å§‹æ—¥æ™‚é †ï¼‰
            const bookedTimes = appData.schedules
                .filter(e => e.type === 'schedule' || e.type === 'task')
                .filter(e => {
                    const start = new Date(e.start);
                    return start >= dayStart && start < new Date(dayStart.getTime() + 24 * 60 * 60 * 1000);
                })
                .map(e => ({
                    start: new Date(e.start),
                    end: new Date(e.end)
                }))
                .sort((a, b) => a.start.getTime() - b.start.getTime());

            let currentCheckTime = dayStart;
            const minSlotDuration = 30 * 60 * 1000; // 30åˆ†ä»¥ä¸Šã®ç©ºã

            for (const booked of bookedTimes) {
                const gapDuration = booked.start.getTime() - currentCheckTime.getTime();

                // äºˆå®šã¨äºˆå®šã®é–“ã€ã¾ãŸã¯ä¸€æ—¥ã®å§‹ã¾ã‚Šã¨æœ€åˆã®äºˆå®šã®é–“ã«ç©ºããŒã‚ã‚‹ã‹
                if (gapDuration >= minSlotDuration) {
                    slots.push({
                        start: currentCheckTime,
                        end: booked.start
                    });
                }
                // ãƒã‚§ãƒƒã‚¯é–‹å§‹æ™‚é–“ã‚’ç¾åœ¨ã®äºˆå®šã®çµ‚äº†æ™‚åˆ»ã«é€²ã‚ã‚‹ (é‡è¤‡è€ƒæ…®ã®ãŸã‚)
                if (booked.end.getTime() > currentCheckTime.getTime()) {
                    currentCheckTime = booked.end;
                }
            }

            // æœ€å¾Œã®äºˆå®šã®çµ‚äº†æ™‚åˆ»ã‹ã‚‰ä¸€æ—¥ã®çµ‚ã‚ã‚Šã¾ã§ã®ç©ºã
            const endGapDuration = dayEnd.getTime() - currentCheckTime.getTime();
            if (endGapDuration >= minSlotDuration) {
                slots.push({
                    start: currentCheckTime,
                    end: dayEnd
                });
            }

            return slots;
        }

        // =======================================================
        // 5. ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        // =======================================================

        /**
         * ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼ã‚’è¨­å®šã—ã€ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’ãƒˆãƒªã‚¬ãƒ¼
         * @param {string} view - 'month', 'week', 'task', 'log'
         */
        function setView(view) {
            appData.currentView = view;
            document.querySelectorAll('footer button').forEach(btn => {
                btn.classList.remove('text-[var(--color-red)]', 'font-extrabold');
                btn.classList.add('text-gray-400');
            });
            document.getElementById(`nav-${view}`).classList.remove('text-gray-400');
            document.getElementById(`nav-${view}`).classList.add('text-[var(--color-red)]', 'font-extrabold');

            renderView(view);
        }

        /**
         * ãƒ¡ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
         * @param {string} view - 'month', 'week', 'task', 'log'
         */
        function renderView(view) {
            viewContainer.innerHTML = ''; // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢

            const headerHtml = (title) => `
                <div class="flex justify-between items-center mb-4 ink-border p-2 bg-gray-50">
                    <button onclick="changeDate(-1)" class="text-2xl steamboat-button">â—€</button>
                    <h2 class="text-xl font-extrabold">${title}</h2>
                    <button onclick="changeDate(1)" class="text-2xl steamboat-button">â–¶</button>
                </div>
            `;

            switch (view) {
                case 'month':
                    renderMonthView(headerHtml);
                    break;
                case 'week':
                    renderWeekView(headerHtml);
                    break;
                case 'task':
                    renderTaskView();
                    break;
                case 'log':
                    renderLogView();
                    break;
            }

            // ã©ã®ãƒ“ãƒ¥ãƒ¼ã§ã‚‚æ–°è¦ä½œæˆãƒœã‚¿ãƒ³ã¯è¡¨ç¤º
            const createButton = document.createElement('button');
            createButton.className = 'fixed right-6 bottom-20 w-12 h-12 bg-[var(--color-red)] text-white text-3xl font-extrabold rounded-full shadow-lg ink-border steamboat-button z-40';
            createButton.innerHTML = '+';
            createButton.onclick = () => showEventForm(null, appData.currentDate);
            viewContainer.appendChild(createButton);
        }

        /**
         * æœˆãƒ“ãƒ¥ãƒ¼ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
         */
        function renderMonthView(headerHtml) {
            const date = appData.currentDate;
            const year = date.getFullYear();
            const month = date.getMonth();
            const today = new Date();

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const startDayOfWeek = firstDayOfMonth.getDay(); // 0=æ—¥æ›œ

            // ãƒ˜ãƒƒãƒ€ãƒ¼ã¨æ—¥ä»˜ã‚¿ã‚¤ãƒˆãƒ«
            viewContainer.innerHTML = headerHtml(`${year}å¹´${month + 1}æœˆ`);

            let html = '<div class="ink-border p-1 bg-white">';
            html += '<div class="grid grid-cols-7 text-center font-bold text-sm bg-gray-200 ink-border-b">';
            ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].forEach(day => {
                html += `<div class="p-2">${day}</div>`;
            });
            html += '</div>';

            html += '<div class="grid grid-cols-7">';

            // å‰æœˆã®æ—¥ä»˜åŸ‹ã‚
            for (let i = 0; i < startDayOfWeek; i++) {
                html += '<div class="h-20 border border-gray-200 bg-gray-50"></div>';
            }

            // ä»Šæœˆã®æ—¥ä»˜
            for (let day = 1; day <= lastDayOfMonth.getDate(); day++) {
                const currentDate = new Date(year, month, day);
                const dayStr = formatDate(currentDate);
                const isToday = dayStr === formatDate(today);

                // ãã®æ—¥ã®äºˆå®šã‚’å–å¾—
                const events = appData.schedules.filter(e => formatDate(new Date(e.start)) === dayStr);
                const eventHtml = events.slice(0, 2).map(e => `
                    <div onclick="event.stopPropagation(); showEventDetails(${e.id})"
                         class="text-xs truncate px-1 mt-0.5 rounded-sm cursor-pointer ${e.type === 'task' ? 'bg-[var(--color-yellow)] text-black' : 'bg-gray-800 text-white'}"
                         title="${e.title}">
                        ${e.type === 'task' ? 'T' : 'S'} ${e.title}
                    </div>
                `).join('');

                const dayClass = isToday ? 'bg-[var(--color-red)] text-white font-extrabold' : 'bg-white';
                html += `
                    <div class="h-20 border border-gray-200 p-0.5 relative cursor-pointer" onclick="showEventForm(null, new Date(${year}, ${month}, ${day}))">
                        <div class="w-6 h-6 rounded-full text-center text-xs flex items-center justify-center ${dayClass}">
                            ${day}
                        </div>
                        <div class="mt-0.5 space-y-0.5">
                            ${eventHtml}
                        </div>
                    </div>
                `;
            }

            html += '</div></div>';
            viewContainer.innerHTML += html;
        }

        /**
         * é€±ãƒ“ãƒ¥ãƒ¼ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
         */
        function renderWeekView(headerHtml) {
            const date = appData.currentDate;
            const today = new Date();
            const dayOfWeek = date.getDay(); // 0 (Sun) to 6 (Sat)
            const weekStart = new Date(date.getFullYear(), date.getMonth(), date.getDate() - dayOfWeek); // ä»Šé€±ã®æ—¥æ›œ

            const weekDates = Array(7).fill(0).map((_, i) => {
                const d = new Date(weekStart);
                d.setDate(weekStart.getDate() + i);
                return d;
            });

            viewContainer.innerHTML = headerHtml(`é€±é–“ ${weekDates[0].getMonth() + 1}/${weekDates[0].getDate()} - ${weekDates[6].getMonth() + 1}/${weekDates[6].getDate()}`);

            let html = '<div class="overflow-x-auto"><div class="min-w-[500px] ink-border bg-white">';

            // æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼
            html += '<div class="grid grid-cols-8 text-center font-bold text-sm bg-gray-200 ink-border-b">';
            html += '<div class="p-2 border-r border-gray-300">æ™‚é–“</div>';
            ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].forEach((day, i) => {
                const d = weekDates[i];
                const dayStr = formatDate(d);
                const isToday = dayStr === formatDate(today);
                const dayClass = isToday ? 'text-[var(--color-red)] font-extrabold' : 'text-black';
                html += `<div class="p-2 border-r border-gray-300 ${dayClass}">${day}<br>${d.getDate()}</div>`;
            });
            html += '</div>';

            // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
            html += '<div class="relative">';
            const hourStart = 8;
            const hourEnd = 23;
            for (let h = hourStart; h < hourEnd; h++) {
                html += `<div class="grid grid-cols-8 h-12 border-b border-gray-200">`;
                html += `<div class="p-1 text-xs text-right border-r border-gray-300 relative"><span class="absolute right-1 -top-2">${h}:00</span></div>`; // æ™‚é–“è¡¨ç¤º

                for (let i = 0; i < 7; i++) {
                    const d = weekDates[i];
                    const dayStr = formatDate(d);
                    const isToday = dayStr === formatDate(today);
                    const colClass = isToday ? 'bg-yellow-50/50' : '';

                    // ãã®æ—¥ãã®æ™‚é–“ã®äºˆå®šã‚’å–å¾—
                    const startOfDay = new Date(d.getFullYear(), d.getMonth(), d.getDate(), h, 0);
                    const endOfHour = new Date(d.getFullYear(), d.getMonth(), d.getDate(), h, 59, 59);

                    const events = appData.schedules
                        .filter(e => new Date(e.start) < endOfHour && new Date(e.end) > startOfDay)
                        .map(e => ({
                            ...e,
                            start: new Date(e.start),
                            end: new Date(e.end)
                        }));

                    let eventsHtml = '';
                    events.forEach(e => {
                        // 1æ™‚é–“å†…ã®äºˆå®šã®é–‹å§‹ãƒ»çµ‚äº†ä½ç½®ã‚’è¨ˆç®—
                        const startMin = e.start.getMinutes();
                        const endMin = e.end.getMinutes();
                        let top = (startMin / 60) * 100;
                        let height = ((e.end.getTime() - e.start.getTime()) / (60 * 60 * 1000)) * 100;

                        // è¤‡æ•°ã®æ—¥ã«ã¾ãŸãŒã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã®èª¿æ•´ (ã“ã“ã§ã¯1æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆã«åã‚ã‚‹ãŸã‚ç°¡ç•¥åŒ–)
                        const startOnThisHour = Math.max(startOfDay.getTime(), e.start.getTime());
                        const endOnThisHour = Math.min(endOfHour.getTime(), e.end.getTime());

                        if (endOnThisHour > startOnThisHour) {
                            const duration = endOnThisHour - startOnThisHour;
                            top = ((startOnThisHour - startOfDay.getTime()) / (60 * 60 * 1000)) * 100;
                            height = (duration / (60 * 60 * 1000)) * 100;

                            // 100%ã‚’è¶…ãˆãªã„ã‚ˆã†ã«èª¿æ•´
                            if (top + height > 100) height = 100 - top;
                            if (top < 0) {
                                height += top;
                                top = 0;
                            }


                            eventsHtml += `
                                <div onclick="event.stopPropagation(); showEventDetails(${e.id})"
                                    class="absolute w-full px-1 text-xs truncate bg-gray-800 text-white rounded-sm cursor-pointer z-20"
                                    style="top: ${top}%; height: ${height}%; left: 0px; box-sizing: border-box;"
                                    title="${e.title}">
                                    ${e.title}
                                </div>
                            `;
                        }
                    });

                    html += `<div class="relative border-r border-gray-300 h-full ${colClass}">${eventsHtml}</div>`;
                }
                html += `</div>`;
            }
            html += '</div></div></div>'; // end of min-w-[500px], end of overflow-x-auto, end of relative
            viewContainer.innerHTML += html;


            // --- ã‚¹ãƒ­ãƒƒãƒˆåˆ†æã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° (é€±ãƒ“ãƒ¥ãƒ¼ã®ã¿ã«é©ç”¨) ---
            const timeLineContainer = viewContainer.querySelector('.relative');
            const dayWidth = timeLineContainer.offsetWidth / 8; // 8åˆ— (æ™‚é–“+7æ—¥)
            const hourHeight = 48; // h-12 (48px)

            weekDates.forEach((d, i) => {
                const slots = analyzeTimeSlots(d);
                const colIndex = i + 1; // 0ã¯æ™‚é–“åˆ—

                slots.forEach(slot => {
                    const start = slot.start;
                    const end = slot.end;

                    // 9:00ã‚’åŸºæº–ã¨ã—ãŸç›¸å¯¾ä½ç½®ã‚’è¨ˆç®— (h=8ãŒé–‹å§‹æ™‚é–“)
                    const totalMinutesFromStart = ((start.getHours() - hourStart) * 60) + start.getMinutes();
                    const durationMinutes = (end.getTime() - start.getTime()) / (60 * 1000);

                    if (totalMinutesFromStart >= 0 && durationMinutes > 0) {
                        const topPosition = (totalMinutesFromStart / 60) * hourHeight;
                        const height = (durationMinutes / 60) * hourHeight;
                        const leftPosition = colIndex * dayWidth;

                        const slotDiv = document.createElement('div');
                        slotDiv.className = 'slot-highlight absolute';
                        slotDiv.style.top = `${topPosition}px`;
                        slotDiv.style.left = `${leftPosition}px`;
                        slotDiv.style.width = `${dayWidth}px`;
                        slotDiv.style.height = `${height}px`;
                        slotDiv.title = `ç©ºãã‚¹ãƒ­ãƒƒãƒˆ: ${start.toTimeString().slice(0, 5)} - ${end.toTimeString().slice(0, 5)}`;
                        timeLineContainer.appendChild(slotDiv);
                    }
                });
            });
        }

        /**
         * ã‚¿ã‚¹ã‚¯ãƒ“ãƒ¥ãƒ¼ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
         */
        function renderTaskView() {
            const tasks = appData.schedules.filter(e => e.type === 'task');
            const pendingTasks = tasks.filter(t => !t.completed).sort((a, b) => new Date(a.end) - new Date(b.end));
            const completedTasks = tasks.filter(t => t.completed).sort((a, b) => new Date(b.actualEnd) - new Date(a.actualEnd));

            let html = '<h2 class="text-xl font-extrabold ink-border-b pb-2 mb-4">ã‚¿ã‚¹ã‚¯ç®¡ç† (Todoãƒªã‚¹ãƒˆ)</h2>';

            // æœªå®Œäº†ã‚¿ã‚¹ã‚¯
            html += '<div class="mb-6">';
            html += '<h3 class="text-lg font-bold text-[var(--color-red)] mb-2">ğŸ”´ æœªå®Œäº†ã‚¿ã‚¹ã‚¯</h3>';
            if (pendingTasks.length === 0) {
                html += '<p class="text-gray-600 italic">ç´ æ™´ã‚‰ã—ã„ï¼æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            } else {
                pendingTasks.forEach(task => {
                    const endDate = new Date(task.end);
                    const deadline = `${endDate.getMonth() + 1}/${endDate.getDate()} ${String(endDate.getHours()).padStart(2, '0')}:${String(endDate.getMinutes()).padStart(2, '0')}`;
                    html += `
                        <div class="ink-border p-3 mb-2 flex justify-between items-center bg-white cursor-pointer steamboat-button" onclick="showEventDetails(${task.id})">
                            <div class="flex-1">
                                <p class="font-bold">${task.title}</p>
                                <p class="text-xs text-gray-600">ç· åˆ‡: ${deadline}</p>
                            </div>
                            <button onclick="event.stopPropagation(); toggleTask(${task.id})" class="steamboat-button bg-[var(--color-yellow)] text-black px-3 py-1 ink-border ml-3">
                                å®Œäº†
                            </button>
                        </div>
                    `;
                });
            }
            html += '</div>';

            // å®Œäº†æ¸ˆã¿ã‚¿ã‚¹ã‚¯
            html += '<div>';
            html += '<h3 class="text-lg font-bold text-[var(--color-yellow)] mb-2">ğŸŸ¡ å®Œäº†æ¸ˆã¿ (æœ€è¿‘5ä»¶)</h3>';
            completedTasks.slice(0, 5).forEach(task => {
                const actualEnd = new Date(task.actualEnd);
                const completedTime = `${actualEnd.getMonth() + 1}/${actualEnd.getDate()} ${String(actualEnd.getHours()).padStart(2, '0')}:${String(actualEnd.getMinutes()).padStart(2, '0')}`;
                html += `
                    <div class="ink-border p-3 mb-2 flex justify-between items-center bg-gray-100 line-through text-gray-500 cursor-pointer steamboat-button" onclick="showEventDetails(${task.id})">
                        <div class="flex-1">
                            <p class="font-bold">${task.title}</p>
                            <p class="text-xs">å®Œäº†: ${completedTime}</p>
                        </div>
                        <button onclick="event.stopPropagation(); toggleTask(${task.id})" class="steamboat-button bg-gray-300 text-black px-3 py-1 ink-border ml-3 text-xs">
                            æˆ»ã™
                        </button>
                    </div>
                `;
            });
            html += '</div>';

            viewContainer.innerHTML = html;
        }

        /**
         * æ—¥èªŒãƒ“ãƒ¥ãƒ¼ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
         */
        function renderLogView() {
            // å®Œäº†ã—ãŸäºˆå®šã¨ã‚¿ã‚¹ã‚¯ã‚’çµåˆã—ã€å®Ÿæ¸¬æ™‚é–“ï¼ˆactualEndï¼‰ã¾ãŸã¯çµ‚äº†æ™‚é–“ï¼ˆendï¼‰ã§ã‚½ãƒ¼ãƒˆ
            const completedEvents = appData.schedules
                .filter(e => e.type === 'schedule' || (e.type === 'task' && e.completed))
                .map(e => ({
                    ...e,
                    logTime: new Date(e.actualEnd || e.end) // ã‚¿ã‚¹ã‚¯ã¯actualEndã€äºˆå®šã¯endã‚’ä½¿ç”¨
                }))
                .sort((a, b) => b.logTime.getTime() - a.logTime.getTime());

            let html = '<h2 class="text-xl font-extrabold ink-border-b pb-2 mb-4">æ—¥èªŒ (ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æŒ¯ã‚Šè¿”ã‚Š)</h2>';

            if (completedEvents.length === 0) {
                html += '<p class="text-gray-600 italic">ã¾ã è¨˜éŒ²ã•ã‚ŒãŸæ—¥èªŒã¯ã‚ã‚Šã¾ã›ã‚“ã€‚äºˆå®šã‚’å®Œäº†ã•ã›ã¾ã—ã‚‡ã†ã€‚</p>';
            } else {
                html += '<div class="relative border-l-4 border-[var(--color-black)] ml-6 p-2">';

                let lastDate = null;

                completedEvents.forEach(e => {
                    const logDate = e.logTime;
                    const logTimeStr = `${String(logDate.getHours()).padStart(2, '0')}:${String(logDate.getMinutes()).padStart(2, '0')}`;
                    const dateStr = `${logDate.getFullYear()}/${logDate.getMonth() + 1}/${logDate.getDate()}`;

                    // æ—¥ä»˜ã®åŒºåˆ‡ã‚Šç·š
                    if (dateStr !== lastDate) {
                        html += `
                            <div class="relative my-4">
                                <div class="absolute -left-8 top-1/2 w-4 h-4 rounded-full bg-[var(--color-red)] ink-border transform -translate-y-1/2"></div>
                                <h3 class="ml-4 font-extrabold text-sm bg-gray-200 inline-block px-2 py-0.5 ink-border-b">${dateStr}</h3>
                            </div>
                        `;
                        lastDate = dateStr;
                    }

                    // ã‚¤ãƒ™ãƒ³ãƒˆã‚¢ã‚¤ãƒ†ãƒ 
                    const itemClass = e.type === 'task' ? 'bg-[var(--color-yellow)] text-black' : 'bg-gray-800 text-white';
                    const durationMs = new Date(e.end).getTime() - new Date(e.start).getTime();
                    const durationHours = (durationMs / (1000 * 60 * 60)).toFixed(1);

                    html += `
                        <div class="relative mb-6">
                            <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®ä¸¸ãƒãƒ -->
                            <div class="absolute -left-8 top-0 w-3 h-3 rounded-full bg-[var(--color-black)] transform translate-x-[2px] mt-1"></div>
                            <div class="ml-4 p-3 ink-border ${itemClass} shadow-lg steamboat-button" onclick="showEventDetails(${e.id})">
                                <p class="text-xs font-bold mb-1">${logTimeStr} - ${e.type === 'task' ? 'ã‚¿ã‚¹ã‚¯å®Œäº†' : 'äºˆå®šçµ‚äº†'}</p>
                                <p class="text-lg font-extrabold">${e.title}</p>
                                <p class="text-xs mt-1">â° äºˆå®šæ™‚é–“: ${durationHours} æ™‚é–“</p>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            }

            viewContainer.innerHTML = html;
        }

        /**
         * æ—¥ä»˜ã®å¤‰æ›´ (æœˆãƒ“ãƒ¥ãƒ¼ã¨é€±ãƒ“ãƒ¥ãƒ¼ã®ç§»å‹•)
         * @param {number} offset - -1 (å‰ã¸) ã¾ãŸã¯ 1 (æ¬¡ã¸)
         */
        function changeDate(offset) {
            const currentView = appData.currentView;
            let newDate = new Date(appData.currentDate);

            if (currentView === 'month') {
                newDate.setMonth(newDate.getMonth() + offset);
            } else if (currentView === 'week') {
                newDate.setDate(newDate.getDate() + (offset * 7));
            } else {
                // ã‚¿ã‚¹ã‚¯ã¨æ—¥èªŒãƒ“ãƒ¥ãƒ¼ã§ã¯å¤‰æ›´ãªã—
                return;
            }

            appData.currentDate = newDate;
            renderView(currentView);
        }

        // =======================================================
        // 6. åˆæœŸåŒ–ã¨å®Ÿè¡Œ
        // =======================================================

        /**
         * åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ (ãƒ‡ãƒ¢ç”¨)
         */
        function initializeDemoData() {
            if (appData.schedules.length > 0) return; // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—

            const now = new Date();
            const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
            const nextWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);

            // äºˆå®š (ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«)
            appData.schedules.push({
                id: 1, title: 'ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã®ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°', type: 'schedule',
                start: new Date(now.getFullYear(), now.getMonth(), now.getDate(), 10, 0).toISOString(),
                end: new Date(now.getFullYear(), now.getMonth(), now.getDate(), 11, 30).toISOString(),
                location: 'å¤§æ‰‹ç”ºãƒ“ãƒ«', notes: 'æ–°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚­ãƒƒã‚¯ã‚ªãƒ•', completed: false, actualEnd: null
            });
            appData.schedules.push({
                id: 2, title: 'ãƒãƒ¼ãƒ ãƒ©ãƒ³ãƒ', type: 'schedule',
                start: new Date(now.getFullYear(), now.getMonth(), now.getDate(), 12, 0).toISOString(),
                end: new Date(now.getFullYear(), now.getMonth(), now.getDate(), 13, 0).toISOString(),
                location: 'ç¤¾é£Ÿ', notes: '', completed: false, actualEnd: null
            });

            // ã‚¿ã‚¹ã‚¯ (æœªå®Œäº†)
            appData.schedules.push({
                id: 3, title: 'é€±å ±ã®ãƒ‰ãƒ©ãƒ•ãƒˆä½œæˆ', type: 'task',
                start: tomorrow.toISOString(),
                end: new Date(tomorrow.getFullYear(), tomorrow.getMonth(), tomorrow.getDate(), 15, 0).toISOString(),
                location: 'è‡ªå®…', notes: 'åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚ã‚‹ã“ã¨', completed: false, actualEnd: null
            });
            appData.schedules.push({
                id: 4, title: 'æ¥é€±ã®ãƒ—ãƒ¬ã‚¼ãƒ³è³‡æ–™æº–å‚™', type: 'task',
                start: nextWeek.toISOString(),
                end: new Date(nextWeek.getFullYear(), nextWeek.getMonth(), nextWeek.getDate(), 10, 0).toISOString(),
                location: '', notes: 'ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å·¥å¤«', completed: false, actualEnd: null
            });

            // ã‚¿ã‚¹ã‚¯ (å®Œäº†æ¸ˆã¿)
            const completedTime = new Date(now.getTime() - 2 * 24 * 60 * 60 * 1000); // 2æ—¥å‰ã®æ™‚é–“
            appData.schedules.push({
                id: 5, title: 'ãƒ¡ãƒ¼ãƒ«ã®è¿”ä¿¡å‡¦ç†', type: 'task',
                start: completedTime.toISOString(),
                end: completedTime.toISOString(),
                location: '', notes: 'ç·Šæ€¥åº¦ã®é«˜ã„ã‚‚ã®å„ªå…ˆ', completed: true, actualEnd: new Date(completedTime.getTime() + 10 * 60 * 1000).toISOString()
            });

            appData.lastId = 5;
            saveData();
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹å§‹
        window.onload = function() {
            // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ã¨åˆæœŸãƒ‡ãƒ¼ã‚¿ä½œæˆ
            loadData();
            initializeDemoData(); // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿

            // ç¾åœ¨æ™‚åˆ»ã®æ›´æ–°ãƒ«ãƒ¼ãƒ—
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);

            // åˆæœŸãƒ“ãƒ¥ãƒ¼ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            setView(appData.currentView);
        };
    </script>
</body>
</html>
